---
title: "Associations between pathway activation and patient survival"
author: "Michael Schubert (schubert@ebi.ac.uk)"
---

```{r setup, include=FALSE}
library(dplyr)
b = import('base')
io = import('io')
ar = import('array')
df = import('data_frame')
st = import('stats')
plt = import('plot')
util = import('../analyses/tcga_survival/util')

#' Loads a specific TCGA scores file
#' supplies path and extension, and cuts rownames at 16 chars
#'
#' @param x  An identifier, like 'speed_matrix'
#' @return   A matrix with primary tumor (01A) samples as rows and genes and columns
#'           This is mapped to TCGA patient IDs
load_fun = function(x) {
    re = io$file_path("../scores/tcga", x, ext=".RData") %>%
        io$load()
    re = re[substr(rownames(re), 14, 16) == "01A",]
    rownames(re) = substr(rownames(re), 1, 16)
    re
}

scores = c('gsea_reactome', 'gsea_go', 'speed_matrix', 'pathifier', 'spia') %>%
    sapply(load_fun, simplify=FALSE, USE.NAMES=TRUE)

assocs.pan = scores %>%
    sapply(util$pancan, simplify=FALSE, USE.NAMES=FALSE) %>%
    df$add_name_col("method") %>%
    bind_rows()

assocs.tissue = util$tissue(scores$speed_matrix)
```

# Pan-cancer associations

```{r pancan, include=FALSE}
##TODO: @suppl
#assocs.pan %>%
#    plt$color$p_effect("adj.p", dir=-1) %>%
#    mutate(label = scores) %>%
#    plt$volcano(base.size=0.1) %>%
#    print()
```

```{r heatmap, echo=FALSE, fig.height=3}
lmax = max(abs(assocs.pan$statistic), na.rm=TRUE)
p1 = assocs.pan %>%
    mutate(statistic = ifelse(adj.p < 0.2, statistic, NA)) %>%
    mutate(label = ifelse(adj.p < 0.05, "*", "")) %>%
    mutate(label = ifelse(adj.p < 1e-4, "***", label)) %>%
    plt$matrix(statistic ~ method + scores, color="statistic", limits=c(-lmax,lmax))
print(p1)
```

# Cancer-specific associations

```{r tissue, echo=FALSE}
##TODO: for all other methods ->@suppl
p2 = assocs.tissue %>%
    plt$color$p_effect("adj.p", dir=-1, thresh=0.1) %>%
    mutate(label = paste(subset, scores, sep=":")) %>%
    plt$volcano(p=0.1)
print(p2)
```
